# LAMMPS Multi-Stage Build Recipe for HoReKa
#
# This recipe creates a minimal runtime container for LAMMPS on HoReKa
# (Intel Xeon Platinum 8368, Ice Lake Server).
# It uses multi-stage builds to exclude compilers and development tools from the
# final image, significantly reducing container size.
#
# Build:
#   apptainer build -F lammps.sif lammps.def
#
# Usage:
#   srun apptainer exec lammps.sif lmp -in input.lammps
#
# Note: Check HoReKa documentation for proper MPI module loading.

######################################################################
# STAGE 1: BUILD
# Full development environment with compilers, headers, and build tools
######################################################################

Bootstrap: docker
From: ubuntu:24.04
Stage: build

%arguments
LAMMPS_VERSION=stable_22Jul2025_update3

# MPI stack versions (matched to HoReKa)
HWLOC_VERSION=2.10.0
LIBEVENT_VERSION=2.1.12
LIBFABRIC_VERSION=1.21.0
MUNGE_VERSION=0.5.13
UCX_VERSION=1.16.0
UCC_VERSION=1.3.0
PMIX_VERSION=5.0.7
PRRTE_VERSION=3.0.5
OMPI_VERSION=5.0.7

# Library versions
FFTW_VERSION=3.3.10
PNETCDF_VERSION=1.14.1

%post
    # ================================================================
    # Configuration from build arguments
    # ================================================================
    LAMMPS_VERSION="{{ LAMMPS_VERSION }}"

    HWLOC_VERSION="{{ HWLOC_VERSION }}"
    LIBEVENT_VERSION="{{ LIBEVENT_VERSION }}"
    LIBFABRIC_VERSION="{{ LIBFABRIC_VERSION }}"
    MUNGE_VERSION="{{ MUNGE_VERSION }}"
    UCX_VERSION="{{ UCX_VERSION }}"
    UCC_VERSION="{{ UCC_VERSION }}"
    PMIX_VERSION="{{ PMIX_VERSION }}"
    PRRTE_VERSION="{{ PRRTE_VERSION }}"
    OMPI_VERSION="{{ OMPI_VERSION }}"
    FFTW_VERSION="{{ FFTW_VERSION }}"
    PNETCDF_VERSION="{{ PNETCDF_VERSION }}"

    echo "=========================================="
    echo "LAMMPS Build Configuration:"
    echo "  LAMMPS Version:  ${LAMMPS_VERSION}"
    echo "  OpenMPI:         ${OMPI_VERSION}"
    echo "  FFTW:            ${FFTW_VERSION}"
    echo "  PnetCDF:         ${PNETCDF_VERSION}"
    echo "=========================================="

    # ================================================================
    # Environment setup
    # ================================================================
    export PATH=/usr/local/bin:$PATH
    export LD_RUN_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
    export MANPATH=/usr/local/share/man:$MANPATH

    export DEBIAN_FRONTEND=noninteractive
    export DEBCONF_NONINTERACTIVE_SEEN=true

    # ================================================================
    # Install base development packages
    # ================================================================
    apt-get update
    apt-get install -y --no-install-recommends \
        software-properties-common \
        strace \
        libnuma-dev \
        libibverbs-dev \
        librdmacm-dev \
        libssl-dev \
        curl \
        wget \
        git \
        bash \
        make \
        file \
        pkg-config \
        gcc \
        g++ \
        python3-dev \
        python3-pip \
        autotools-dev \
        autoconf \
        libtool-bin \
        libncurses5-dev \
        cmake \
        ca-certificates \
        bzip2 \
        xz-utils \
        automake \
        libjpeg-dev \
        libpng-dev

    # Optimization flags for Ice Lake Server (Intel Xeon Platinum 8368)
    export OPT_FLAGS="-O3 -march=icelake-server"
    export CFLAGS="${OPT_FLAGS}"
    export CXXFLAGS="${OPT_FLAGS}"

    # ================================================================
    # Build HWLOC
    # ================================================================
    echo "Building HWLOC ${HWLOC_VERSION}..."
    rm -rf /tmp/hwloc-${HWLOC_VERSION}
    curl -sL https://download.open-mpi.org/release/hwloc/v2.10/hwloc-${HWLOC_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/hwloc-${HWLOC_VERSION}
    ./configure --prefix=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/hwloc-${HWLOC_VERSION}

    # ================================================================
    # Build libfabric
    # ================================================================
    echo "Building libfabric ${LIBFABRIC_VERSION}..."
    rm -rf /tmp/libfabric-${LIBFABRIC_VERSION}
    curl -sL https://github.com/ofiwg/libfabric/releases/download/v${LIBFABRIC_VERSION}/libfabric-${LIBFABRIC_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/libfabric-${LIBFABRIC_VERSION}
    # Keep: tcp, shm for local testing; verbs for HoReKa InfiniBand
    ./configure --prefix=/usr/local \
        --disable-efa \
        --enable-tcp \
        --enable-shm \
        --enable-verbs
    make -j$(nproc)
    make install
    rm -rf /tmp/libfabric-${LIBFABRIC_VERSION}

    # ================================================================
    # Build MUNGE
    # ================================================================
    echo "Building MUNGE ${MUNGE_VERSION}..."
    rm -rf /tmp/munge-${MUNGE_VERSION}
    curl -sL https://github.com/dun/munge/releases/download/munge-${MUNGE_VERSION}/munge-${MUNGE_VERSION}.tar.xz | tar --no-same-owner -xJC /tmp
    cd /tmp/munge-${MUNGE_VERSION}
    ./configure --prefix=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/munge-${MUNGE_VERSION}

    # ================================================================
    # Build libevent
    # ================================================================
    echo "Building libevent ${LIBEVENT_VERSION}..."
    rm -rf /tmp/libevent-${LIBEVENT_VERSION}-stable
    curl -sL https://github.com/libevent/libevent/releases/download/release-${LIBEVENT_VERSION}-stable/libevent-${LIBEVENT_VERSION}-stable.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/libevent-${LIBEVENT_VERSION}-stable
    ./configure --prefix=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/libevent-${LIBEVENT_VERSION}-stable

    # ================================================================
    # Build UCX
    # ================================================================
    echo "Building UCX ${UCX_VERSION}..."
    rm -rf /tmp/ucx-${UCX_VERSION}
    curl -sL https://github.com/openucx/ucx/releases/download/v${UCX_VERSION}/ucx-${UCX_VERSION}.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/ucx-${UCX_VERSION}
    ./configure --prefix=/usr/local \
        --enable-optimizations \
        --enable-cma \
        --enable-mt \
        --with-verbs \
        --without-java \
        --without-go \
        --disable-doxygen-doc \
        --disable-logging \
        --disable-debug \
        --disable-assertions \
        --disable-params-check
    make -j$(nproc)
    make install
    rm -rf /tmp/ucx-${UCX_VERSION}

    # ================================================================
    # Build UCC
    # ================================================================
    echo "Building UCC ${UCC_VERSION}..."
    # Run ldconfig to ensure UCX libraries are discoverable
    ldconfig
    rm -rf /tmp/ucc-${UCC_VERSION}
    curl -sL https://github.com/openucx/ucc/archive/refs/tags/v${UCC_VERSION}.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/ucc-${UCC_VERSION}
    ./autogen.sh
    ./configure --prefix=/usr/local --with-ucx=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/ucc-${UCC_VERSION}

    # ================================================================
    # Build PMIx
    # ================================================================
    echo "Building PMIx ${PMIX_VERSION}..."
    rm -rf /tmp/pmix-${PMIX_VERSION}
    curl -sL https://github.com/openpmix/openpmix/releases/download/v${PMIX_VERSION}/pmix-${PMIX_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/pmix-${PMIX_VERSION}
    ./configure --prefix=/usr/local --with-libevent=/usr/local --with-hwloc=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/pmix-${PMIX_VERSION}

    # ================================================================
    # Build PRRTE
    # ================================================================
    echo "Building PRRTE ${PRRTE_VERSION}..."
    rm -rf /tmp/prrte-${PRRTE_VERSION}
    curl -sL https://github.com/openpmix/prrte/releases/download/v${PRRTE_VERSION}/prrte-${PRRTE_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/prrte-${PRRTE_VERSION}
    ./configure --prefix=/usr/local --with-libevent=/usr/local --with-hwloc=/usr/local --with-pmix=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/prrte-${PRRTE_VERSION}

    # ================================================================
    # Build OpenMPI
    # ================================================================
    echo "Building OpenMPI ${OMPI_VERSION}..."
    rm -rf /tmp/openmpi-${OMPI_VERSION}
    curl -sL https://download.open-mpi.org/release/open-mpi/v5.0/openmpi-${OMPI_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/openmpi-${OMPI_VERSION}
    # Slurm handles starting of processes and initial communication with the
    # process runs through PMIx. We also disable verbs because this
    # leads to warnings that it is not being used anyway.
    ./configure --prefix=/usr/local \
        --enable-shared \
        --enable-static \
        --enable-mpi-fortran=no \
        --without-orte \
        --disable-oshmem \
        --without-verbs \
        --without-psm2 \
        --with-hwloc=/usr/local \
        --with-libevent=/usr/local \
        --with-ofi=/usr/local \
        --with-ucx=/usr/local \
        --with-ucc=/usr/local \
        --with-pmix=/usr/local \
        --with-prrte=/usr/local \
        --with-slurm
    make -j$(nproc)
    make install
    rm -rf /tmp/openmpi-${OMPI_VERSION}

    # ================================================================
    # Build FFTW with MPI support
    # ================================================================
    echo "Building FFTW ${FFTW_VERSION}..."
    rm -rf /tmp/fftw-${FFTW_VERSION}
    curl -sL http://www.fftw.org/fftw-${FFTW_VERSION}.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/fftw-${FFTW_VERSION}
    ./configure --prefix=/usr/local \
        --enable-shared \
        --enable-mpi \
        --disable-fortran \
        --enable-sse2 \
        --enable-avx \
        --enable-avx2 \
        --enable-avx512
    make -j$(nproc)
    make install
    rm -rf /tmp/fftw-${FFTW_VERSION}

    # ================================================================
    # Build PnetCDF
    # ================================================================
    echo "Building PnetCDF ${PNETCDF_VERSION}..."
    rm -rf /tmp/pnetcdf-${PNETCDF_VERSION}
    curl -sL https://parallel-netcdf.github.io/Release/pnetcdf-${PNETCDF_VERSION}.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/pnetcdf-${PNETCDF_VERSION}
    ./configure --prefix=/usr/local \
        --enable-shared \
        --disable-fortran \
        --disable-cxx \
        MPICC=/usr/local/bin/mpicc \
        MPICXX=/usr/local/bin/mpicxx
    make -j$(nproc)
    make install
    rm -rf /tmp/pnetcdf-${PNETCDF_VERSION}

    # ================================================================
    # Build LAMMPS
    # ================================================================
    echo "Building LAMMPS ${LAMMPS_VERSION}..."
    rm -rf /tmp/lammps
    git clone -b ${LAMMPS_VERSION} https://github.com/lammps/lammps.git /tmp/lammps
    rm -rf /tmp/lammps-build
    mkdir /tmp/lammps-build
    cd /tmp/lammps-build
    cmake \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DCMAKE_TUNE_FLAGS="-march=icelake-server" \
        -DBUILD_MPI=on \
        -DBUILD_OMP=off \
        -DPKG_DPD-BASIC=on \
        -DPKG_DPD-MESO=on \
        -DPKG_EXTRA-COMPUTE=on \
        -DPKG_EXTRA-PAIR=on \
        -DPKG_KSPACE=on \
        -DPKG_MANYBODY=on \
        -DPKG_MISC=on \
        -DPKG_ML-PACE=on \
        -DPKG_MANIFOLD=on \
        -DPKG_MOLECULE=on \
        -DPKG_MOLFILE=on \
        -DPKG_NETCDF=on \
        -DPKG_OPT=on \
        -DPKG_REACTION=on \
        -DPKG_REPLICA=on \
        -DPKG_RIGID=on \
        -DPKG_VORONOI=on \
        -DWITH_JPEG=on \
        -DWITH_PNG=on \
        /tmp/lammps/cmake
    make -j$(nproc)
    make install
    rm -rf /tmp/lammps /tmp/lammps-build

    # ================================================================
    # Prepare staging area with only runtime files
    # ================================================================
    echo "Preparing staging area..."
    mkdir -p /staging/usr/local/lib
    mkdir -p /staging/usr/local/bin
    mkdir -p /staging/usr/local/share
    mkdir -p /staging/usr/lib
    mkdir -p /staging/etc

    # -------------------------------
    # Copy all shared libraries from /usr/local/lib
    # -------------------------------
    find /usr/local/lib -name "*.so*" -type f -exec cp -a {} /staging/usr/local/lib/ \;
    find /usr/local/lib -name "*.so*" -type l -exec cp -a {} /staging/usr/local/lib/ \;

    # Copy plugin directories (UCX, UCC, OpenMPI, PMIx)
    cp -a /usr/local/lib/ucx /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /usr/local/lib/ucc /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /usr/local/lib/openmpi /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /usr/local/lib/pmix /staging/usr/local/lib/ 2>/dev/null || true

    # LAMMPS binary
    cp -a /usr/local/bin/lmp /staging/usr/local/bin/

    # MPI binaries
    cp -a /usr/local/bin/mpirun /staging/usr/local/bin/ 2>/dev/null || true
    cp -a /usr/local/bin/mpiexec /staging/usr/local/bin/ 2>/dev/null || true
    cp -a /usr/local/bin/orte* /staging/usr/local/bin/ 2>/dev/null || true
    cp -a /usr/local/bin/ompi* /staging/usr/local/bin/ 2>/dev/null || true

    # MPI/HPC data files
    cp -a /usr/local/share/openmpi /staging/usr/local/share/ 2>/dev/null || true
    cp -a /usr/local/share/pmix /staging/usr/local/share/ 2>/dev/null || true
    cp -a /usr/local/share/hwloc /staging/usr/local/share/ 2>/dev/null || true
    # LAMMPS potentials and data files
    cp -a /usr/local/share/lammps /staging/usr/local/share/ 2>/dev/null || true

    # -------------------------------
    # System runtime libraries
    # -------------------------------
    # OpenMP runtime
    cp -a /usr/lib/x86_64-linux-gnu/libgomp*.so* /staging/usr/lib/ 2>/dev/null || true
    # GCC atomic operations (needed by libfabric)
    cp -a /usr/lib/x86_64-linux-gnu/libatomic*.so* /staging/usr/lib/ 2>/dev/null || true
    # InfiniBand/RDMA - base libraries only
    cp -a /usr/lib/x86_64-linux-gnu/libibverbs*.so* /staging/usr/lib/ 2>/dev/null || true
    cp -a /usr/lib/x86_64-linux-gnu/librdmacm*.so* /staging/usr/lib/ 2>/dev/null || true
    cp -a /usr/lib/x86_64-linux-gnu/libnl*.so* /staging/usr/lib/ 2>/dev/null || true
    # NUMA
    cp -a /usr/lib/x86_64-linux-gnu/libnuma*.so* /staging/usr/lib/ 2>/dev/null || true
    # Other dependencies
    cp -a /usr/lib/x86_64-linux-gnu/libltdl*.so* /staging/usr/lib/ 2>/dev/null || true
    cp -a /usr/lib/x86_64-linux-gnu/libxml2*.so* /staging/usr/lib/ 2>/dev/null || true
    # JPEG and PNG (needed by LAMMPS dump image)
    cp -a /usr/lib/x86_64-linux-gnu/libjpeg*.so* /staging/usr/lib/ 2>/dev/null || true
    cp -a /usr/lib/x86_64-linux-gnu/libpng*.so* /staging/usr/lib/ 2>/dev/null || true

    # -------------------------------
    # Build info
    # -------------------------------
    cat > /staging/etc/lammps-build-info << EOF
LAMMPS_VERSION=${LAMMPS_VERSION}
OMPI_VERSION=${OMPI_VERSION}
FFTW_VERSION=${FFTW_VERSION}
PNETCDF_VERSION=${PNETCDF_VERSION}
BUILD_DATE=$(date -Iseconds)
TARGET_ARCH=icelake-server
EOF

    echo "=========================================="
    echo "Staging area summary:"
    du -sh /staging/*
    echo "=========================================="


######################################################################
# STAGE 2: RUNTIME
# Minimal Ubuntu container with only essential runtime components
######################################################################

Bootstrap: docker
From: ubuntu:24.04
Stage: runtime

%files from build
    /staging/usr/local/ /usr/local
    /staging/usr/lib/ /usr/lib
    /staging/etc/lammps-build-info /etc/lammps-build-info

%post
    export DEBIAN_FRONTEND=noninteractive

    # ================================================================
    # Install only essential runtime packages
    # ================================================================
    apt-get update
    apt-get install -y --no-install-recommends \
        libstdc++6 \
        libgcc-s1 \
        libc6 \
        zlib1g \
        liblzma5 \
        libffi8 \
        libnuma1 \
        libjpeg8 \
        libpng16-16 \
        ibverbs-providers \
        ca-certificates

    # ================================================================
    # Cleanup to minimize image size
    # ================================================================
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    rm -rf /usr/share/doc /usr/share/man /usr/share/info
    rm -rf /var/cache/apt/archives

    # ================================================================
    # Configure library paths
    # ================================================================
    cat > /etc/ld.so.conf.d/lammps.conf << 'EOF'
/usr/local/lib
/usr/local/lib/openmpi
/usr/lib
EOF

    ldconfig

%environment
    export PATH=/usr/local/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib/openmpi:$LD_LIBRARY_PATH
    export OPAL_PREFIX=/usr/local
    export LC_ALL=C

%runscript
    exec /usr/local/bin/lmp "$@"

%test
    /usr/local/bin/lmp -h

%help
    LAMMPS - Molecular Dynamics Simulator for HoReKa
    =================================================

    This container provides LAMMPS compiled for Intel Xeon Platinum 8368
    Ice Lake Server (HoReKa).
    Multi-stage build for minimal container size.

    Build info: /etc/lammps-build-info

    Features:
      - OpenMPI 5.0.7 with UCX transport
      - FFTW 3.3.10 with MPI support
      - PnetCDF 1.14.1 for parallel I/O
      - Packages: DPD-BASIC, DPD-MESO, EXTRA-COMPUTE, EXTRA-PAIR, KSPACE,
                  MANYBODY, MANIFOLD, MISC, ML-PACE, MOLECULE, MOLFILE,
                  NETCDF, OPT, REACTION, REPLICA, RIGID, VORONOI
      - JPEG and PNG support for dump images

    Usage:
      # Run LAMMPS input script
      srun apptainer exec lammps.sif lmp -in input.lammps

      # Run with container as runscript
      srun apptainer run lammps.sif -in input.lammps

      # Check LAMMPS version
      apptainer exec lammps.sif lmp -h

    Note: Check HoReKa documentation for proper MPI module loading
    and Slurm integration.

%labels
    Author Pastewka Lab
    Version {{ LAMMPS_VERSION }}
    Description LAMMPS for HoReKa (Ice Lake Server) - minimal runtime container
