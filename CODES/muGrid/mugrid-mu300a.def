Bootstrap: localimage
From: netcdf_fftw_pfft.sif

%post

    if [ -e /usr/share/modulefiles ]; then
        export MODULEPATH=/usr/share/modulefiles
        source /usr/share/lmod/lmod/init/bash
        module load mpi
    fi

    # Set environment variable to contain /usr/local
    export PATH=/usr/local/bin:$PATH
    export LD_RUN_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
    export MANPATH=/usr/local/share/man:$MANPATH

    # For apt to be noninteractive
    export DEBIAN_FRONTEND=noninteractive
    export DEBCONF_NONINTERACTIVE_SEEN=true

    if $(command -v dnf); then
        # We are on RedHat
        dnf install -y boost-devel
    else
        # We are on Debian
        apt-get install -y libboost-test-dev
    fi

    # Install Python dependencies for muGrid
    pip install --break-system-packages pybind11 numpy

    # Clone muGrid
    export MUGRID_SRC_DIR=/tmp/mugrid
    export MUGRID_BUILD_DIR=/tmp/mugrid-build
    export MUGRID_BRANCH=0.102.0
    rm -rf ${MUGRID_SRC_DIR} ${MUGRID_BUILD_DIR}
    git clone --recurse-submodules -b ${MUGRID_BRANCH} https://github.com/muSpectre/muGrid.git ${MUGRID_SRC_DIR}

    # NEMO: -march=sandybridge -mno-avx512f
    # JUWELS: -march=skylake
    # NEMO2: -march=znver4
    # https://www.amd.com/content/dam/amd/en/documents/developer/compiler-options-quick-ref-guide-amd-epyc-9xx4-series-processors.pdf
    export OPT_FLAGS="-O2 -march=znver4"

    # Build muGrid with CMake (out-of-source build)
    mkdir -p ${MUGRID_BUILD_DIR}
    cd ${MUGRID_BUILD_DIR}
    cmake ${MUGRID_SRC_DIR} \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_C_FLAGS="${OPT_FLAGS}" \
        -DCMAKE_CXX_FLAGS="${OPT_FLAGS}" \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DCMAKE_PREFIX_PATH=/usr/local \
        -DMUGRID_ENABLE_HIP=ON \
        -DMUGRID_ENABLE_MPI=ON
    make -j$(nproc)
    make install

    # Clean up build directories
    rm -rf ${MUGRID_SRC_DIR} ${MUGRID_BUILD_DIR}

%runscript

    python3 "$@"
