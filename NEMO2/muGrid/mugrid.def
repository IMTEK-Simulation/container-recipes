# muGrid Multi-Stage Build Recipe for NEMO2
#
# This recipe creates a minimal runtime container for muGrid on NEMO2 (AMD EPYC Milan/Zen3).
# It uses multi-stage builds to exclude compilers and development tools from the
# final image, significantly reducing container size.
#
# Build:
#   apptainer build -F mugrid.sif mugrid.def
#
# Usage:
#   srun apptainer run mugrid.sif script.py
#   srun apptainer exec mugrid.sif python3 -c "import muGrid; print(muGrid.__version__)"
#
# Note: Do NOT load any MPI module on NEMO2. Slurm handles process management.

######################################################################
# STAGE 1: BUILD
# Full development environment with compilers, headers, and build tools
######################################################################

Bootstrap: docker
From: ubuntu:24.04
Stage: build

%arguments
MUGRID_VERSION=0.102.0

# MPI stack versions (matched to NEMO2)
AOCC_VERSION=5.0.0
HWLOC_VERSION=2.10.0
LIBEVENT_VERSION=2.1.12
LIBFABRIC_VERSION=1.21.0
MUNGE_VERSION=0.5.13
UCX_VERSION=1.16.0
UCC_VERSION=1.3.0
PMIX_VERSION=5.0.7
PRRTE_VERSION=3.0.5
OMPI_VERSION=5.0.7
MPI4PY_VERSION=4.0.3

# Library versions
FFTW_VERSION=3.3.10
PNETCDF_VERSION=1.14.0

%post
    # ================================================================
    # Configuration from build arguments
    # ================================================================
    MUGRID_VERSION="{{ MUGRID_VERSION }}"

    AOCC_VERSION="{{ AOCC_VERSION }}"
    HWLOC_VERSION="{{ HWLOC_VERSION }}"
    LIBEVENT_VERSION="{{ LIBEVENT_VERSION }}"
    LIBFABRIC_VERSION="{{ LIBFABRIC_VERSION }}"
    MUNGE_VERSION="{{ MUNGE_VERSION }}"
    UCX_VERSION="{{ UCX_VERSION }}"
    UCC_VERSION="{{ UCC_VERSION }}"
    PMIX_VERSION="{{ PMIX_VERSION }}"
    PRRTE_VERSION="{{ PRRTE_VERSION }}"
    OMPI_VERSION="{{ OMPI_VERSION }}"
    MPI4PY_VERSION="{{ MPI4PY_VERSION }}"
    FFTW_VERSION="{{ FFTW_VERSION }}"
    PNETCDF_VERSION="{{ PNETCDF_VERSION }}"

    echo "=========================================="
    echo "muGrid Build Configuration:"
    echo "  muGrid Version:  ${MUGRID_VERSION}"
    echo "  OpenMPI:         ${OMPI_VERSION}"
    echo "  FFTW:            ${FFTW_VERSION}"
    echo "  PnetCDF:         ${PNETCDF_VERSION}"
    echo "=========================================="

    # ================================================================
    # Environment setup
    # ================================================================
    export PATH=/usr/local/bin:$PATH
    export LD_RUN_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
    export MANPATH=/usr/local/share/man:$MANPATH

    export DEBIAN_FRONTEND=noninteractive
    export DEBCONF_NONINTERACTIVE_SEEN=true

    # ================================================================
    # Install base development packages
    # ================================================================
    apt-get update
    apt-get install -y --no-install-recommends \
        software-properties-common \
        strace \
        libnuma-dev \
        libibverbs-dev \
        librdmacm-dev \
        libssl-dev \
        curl \
        wget \
        git \
        bash \
        make \
        file \
        pkg-config \
        gcc \
        g++ \
        gfortran \
        python3-dev \
        python3-pip \
        autotools-dev \
        autoconf \
        libtool-bin \
        libncurses5-dev \
        cmake \
        ca-certificates \
        bzip2 \
        xz-utils \
        automake \
        libboost-test-dev

    # ================================================================
    # Install AMD AOCC compiler (optimized for Zen4)
    # ================================================================
    cd /tmp
    wget -q https://download.amd.com/developer/eula/aocc/aocc-5-0/aocc-compiler-${AOCC_VERSION}_1_amd64.deb
    dpkg -i aocc-compiler-${AOCC_VERSION}_1_amd64.deb
    rm aocc-compiler-${AOCC_VERSION}_1_amd64.deb

    # Configure AOCC environment
    . /opt/AMD/aocc-compiler-${AOCC_VERSION}/setenv_AOCC.sh
    export CC=clang
    export CXX=clang++
    export FC=flang

    # Optimization flags for Milan (Zen3)
    export OPT_FLAGS="-O3 -march=znver3"
    export CFLAGS="${OPT_FLAGS}"
    export CXXFLAGS="${OPT_FLAGS}"
    export FFLAGS="${OPT_FLAGS}"

    # ================================================================
    # Build HWLOC
    # ================================================================
    echo "Building HWLOC ${HWLOC_VERSION}..."
    rm -rf /tmp/hwloc-${HWLOC_VERSION}
    curl -sL https://download.open-mpi.org/release/hwloc/v2.10/hwloc-${HWLOC_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/hwloc-${HWLOC_VERSION}
    ./configure --prefix=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/hwloc-${HWLOC_VERSION}

    # ================================================================
    # Build libfabric
    # ================================================================
    echo "Building libfabric ${LIBFABRIC_VERSION}..."
    rm -rf /tmp/libfabric-${LIBFABRIC_VERSION}
    curl -sL https://github.com/ofiwg/libfabric/releases/download/v${LIBFABRIC_VERSION}/libfabric-${LIBFABRIC_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/libfabric-${LIBFABRIC_VERSION}
    ./configure --prefix=/usr/local \
        --disable-efa \
        --enable-tcp \
        --enable-shm \
        --enable-verbs
    make -j$(nproc)
    make install
    rm -rf /tmp/libfabric-${LIBFABRIC_VERSION}

    # ================================================================
    # Build MUNGE
    # ================================================================
    echo "Building MUNGE ${MUNGE_VERSION}..."
    rm -rf /tmp/munge-${MUNGE_VERSION}
    curl -sL https://github.com/dun/munge/releases/download/munge-${MUNGE_VERSION}/munge-${MUNGE_VERSION}.tar.xz | tar --no-same-owner -xJC /tmp
    cd /tmp/munge-${MUNGE_VERSION}
    ./configure --prefix=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/munge-${MUNGE_VERSION}

    # ================================================================
    # Build libevent
    # ================================================================
    echo "Building libevent ${LIBEVENT_VERSION}..."
    rm -rf /tmp/libevent-${LIBEVENT_VERSION}-stable
    curl -sL https://github.com/libevent/libevent/releases/download/release-${LIBEVENT_VERSION}-stable/libevent-${LIBEVENT_VERSION}-stable.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/libevent-${LIBEVENT_VERSION}-stable
    ./configure --prefix=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/libevent-${LIBEVENT_VERSION}-stable

    # ================================================================
    # Build UCX
    # ================================================================
    echo "Building UCX ${UCX_VERSION}..."
    rm -rf /tmp/ucx-${UCX_VERSION}
    curl -sL https://github.com/openucx/ucx/releases/download/v${UCX_VERSION}/ucx-${UCX_VERSION}.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/ucx-${UCX_VERSION}
    CFLAGS="${CFLAGS} -Wno-unused-but-set-variable" \
    CXXFLAGS="${CXXFLAGS} -Wno-unused-but-set-variable" \
    ./configure --prefix=/usr/local \
        --enable-optimizations \
        --enable-cma \
        --enable-mt \
        --with-verbs \
        --without-java \
        --without-go \
        --disable-doxygen-doc \
        --disable-logging \
        --disable-debug \
        --disable-assertions \
        --disable-params-check
    make -j$(nproc)
    make install
    rm -rf /tmp/ucx-${UCX_VERSION}

    # ================================================================
    # Build UCC
    # ================================================================
    echo "Building UCC ${UCC_VERSION}..."
    ldconfig
    rm -rf /tmp/ucc-${UCC_VERSION}
    curl -sL https://github.com/openucx/ucc/archive/refs/tags/v${UCC_VERSION}.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/ucc-${UCC_VERSION}
    ./autogen.sh
    ./configure --prefix=/usr/local --with-ucx=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/ucc-${UCC_VERSION}

    # ================================================================
    # Build PMIx
    # ================================================================
    echo "Building PMIx ${PMIX_VERSION}..."
    rm -rf /tmp/pmix-${PMIX_VERSION}
    curl -sL https://github.com/openpmix/openpmix/releases/download/v${PMIX_VERSION}/pmix-${PMIX_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/pmix-${PMIX_VERSION}
    ./configure --prefix=/usr/local --with-libevent=/usr/local --with-hwloc=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/pmix-${PMIX_VERSION}

    # ================================================================
    # Build PRRTE
    # ================================================================
    echo "Building PRRTE ${PRRTE_VERSION}..."
    rm -rf /tmp/prrte-${PRRTE_VERSION}
    curl -sL https://github.com/openpmix/prrte/releases/download/v${PRRTE_VERSION}/prrte-${PRRTE_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/prrte-${PRRTE_VERSION}
    ./configure --prefix=/usr/local --with-libevent=/usr/local --with-hwloc=/usr/local --with-pmix=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/prrte-${PRRTE_VERSION}

    # ================================================================
    # Build OpenMPI
    # ================================================================
    echo "Building OpenMPI ${OMPI_VERSION}..."
    rm -rf /tmp/openmpi-${OMPI_VERSION}
    curl -sL https://download.open-mpi.org/release/open-mpi/v5.0/openmpi-${OMPI_VERSION}.tar.bz2 | tar --no-same-owner -xjC /tmp
    cd /tmp/openmpi-${OMPI_VERSION}
    ./configure --prefix=/usr/local \
        --enable-shared \
        --without-orte \
        --disable-oshmem \
        --without-verbs \
        --without-psm2 \
        --with-hwloc=/usr/local \
        --with-libevent=/usr/local \
        --with-ofi=/usr/local \
        --with-ucx=/usr/local \
        --with-ucc=/usr/local \
        --with-pmix=/usr/local \
        --with-prrte=/usr/local
    make -j$(nproc)
    make install
    rm -rf /tmp/openmpi-${OMPI_VERSION}

    # ================================================================
    # Build FFTW with MPI support
    # ================================================================
    echo "Building FFTW ${FFTW_VERSION}..."
    rm -rf /tmp/fftw-${FFTW_VERSION}
    curl -sL http://www.fftw.org/fftw-${FFTW_VERSION}.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/fftw-${FFTW_VERSION}
    ./configure --prefix=/usr/local \
        --enable-shared \
        --enable-mpi \
        --disable-fortran \
        --enable-sse2 \
        --enable-avx \
        --enable-avx2 \
        --enable-avx512
    make -j$(nproc)
    make install
    rm -rf /tmp/fftw-${FFTW_VERSION}

    # ================================================================
    # Build PnetCDF
    # ================================================================
    echo "Building PnetCDF ${PNETCDF_VERSION}..."
    rm -rf /tmp/pnetcdf-${PNETCDF_VERSION}
    curl -sL https://parallel-netcdf.github.io/Release/pnetcdf-${PNETCDF_VERSION}.tar.gz | tar --no-same-owner -xzC /tmp
    cd /tmp/pnetcdf-${PNETCDF_VERSION}
    ./configure --prefix=/usr/local \
        --enable-shared \
        --disable-fortran \
        MPICC=/usr/local/bin/mpicc \
        MPICXX=/usr/local/bin/mpicxx
    make -j$(nproc)
    make install
    rm -rf /tmp/pnetcdf-${PNETCDF_VERSION}

    # ================================================================
    # Install Python packages
    # ================================================================
    echo "Installing Python packages..."
    cd /tmp
    pip install --break-system-packages --no-cache-dir \
        numpy \
        scipy \
        pybind11

    # Install mpi4py (compile from source to use our MPI)
    pip install --break-system-packages --no-cache-dir --no-binary mpi4py mpi4py==${MPI4PY_VERSION}

    # Install NuMPI
    pip install --break-system-packages --no-cache-dir NuMPI

    # ================================================================
    # Build muGrid
    # ================================================================
    echo "Building muGrid ${MUGRID_VERSION}..."

    export MUGRID_SRC_DIR=/tmp/mugrid
    export MUGRID_BUILD_DIR=/tmp/mugrid-build

    rm -rf ${MUGRID_SRC_DIR} ${MUGRID_BUILD_DIR}
    git clone --recurse-submodules -b ${MUGRID_VERSION} \
        https://github.com/muSpectre/muGrid.git ${MUGRID_SRC_DIR}

    mkdir -p ${MUGRID_BUILD_DIR}
    cd ${MUGRID_BUILD_DIR}

    cmake ${MUGRID_SRC_DIR} \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_C_FLAGS="${OPT_FLAGS}" \
        -DCMAKE_CXX_FLAGS="${OPT_FLAGS}" \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DCMAKE_PREFIX_PATH=/usr/local \
        -DMUGRID_ENABLE_MPI=ON

    make -j$(nproc)
    make install

    rm -rf ${MUGRID_SRC_DIR} ${MUGRID_BUILD_DIR}

    # ================================================================
    # Prepare staging area with only runtime files
    # ================================================================
    echo "Preparing staging area..."
    mkdir -p /staging/usr/local/lib
    mkdir -p /staging/usr/local/bin
    mkdir -p /staging/usr/local/share
    mkdir -p /staging/usr/lib
    mkdir -p /staging/etc

    # -------------------------------
    # Copy all shared libraries from /usr/local/lib
    # -------------------------------
    find /usr/local/lib -name "*.so*" -type f -exec cp -a {} /staging/usr/local/lib/ \;
    find /usr/local/lib -name "*.so*" -type l -exec cp -a {} /staging/usr/local/lib/ \;

    # Copy plugin directories (UCX, UCC, OpenMPI, PMIx)
    cp -a /usr/local/lib/ucx /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /usr/local/lib/ucc /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /usr/local/lib/openmpi /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /usr/local/lib/pmix /staging/usr/local/lib/ 2>/dev/null || true

    # AOCC runtime libraries (compiler runtimes)
    cp -a /opt/AMD/aocc-compiler-*/lib/libflang*.so* /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /opt/AMD/aocc-compiler-*/lib/libFortran*.so* /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /opt/AMD/aocc-compiler-*/lib/libomp*.so* /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /opt/AMD/aocc-compiler-*/lib/libamdlibm*.so* /staging/usr/local/lib/ 2>/dev/null || true
    cp -a /opt/AMD/aocc-compiler-*/lib/libpgmath*.so* /staging/usr/local/lib/ 2>/dev/null || true

    # Python packages
    cp -a /usr/local/lib/python3* /staging/usr/local/lib/

    # MPI binaries
    cp -a /usr/local/bin/mpirun /staging/usr/local/bin/ 2>/dev/null || true
    cp -a /usr/local/bin/mpiexec /staging/usr/local/bin/ 2>/dev/null || true
    cp -a /usr/local/bin/orte* /staging/usr/local/bin/ 2>/dev/null || true
    cp -a /usr/local/bin/ompi* /staging/usr/local/bin/ 2>/dev/null || true

    # MPI/HPC data files
    cp -a /usr/local/share/openmpi /staging/usr/local/share/ 2>/dev/null || true
    cp -a /usr/local/share/pmix /staging/usr/local/share/ 2>/dev/null || true
    cp -a /usr/local/share/hwloc /staging/usr/local/share/ 2>/dev/null || true

    # CMake config for downstream builds (optional)
    mkdir -p /staging/usr/local/lib/cmake
    cp -a /usr/local/lib/cmake/muGrid /staging/usr/local/lib/cmake/ 2>/dev/null || true

    # -------------------------------
    # System runtime libraries
    # -------------------------------
    # Boost test runtime
    cp -a /usr/lib/x86_64-linux-gnu/libboost_unit_test_framework*.so* /staging/usr/lib/ 2>/dev/null || true
    # OpenMP runtime
    cp -a /usr/lib/x86_64-linux-gnu/libgomp*.so* /staging/usr/lib/ 2>/dev/null || true
    # Fortran runtime
    cp -a /usr/lib/x86_64-linux-gnu/libgfortran*.so* /staging/usr/lib/ 2>/dev/null || true
    cp -a /usr/lib/x86_64-linux-gnu/libquadmath*.so* /staging/usr/lib/ 2>/dev/null || true
    # GCC atomic operations
    cp -a /usr/lib/x86_64-linux-gnu/libatomic*.so* /staging/usr/lib/ 2>/dev/null || true
    # InfiniBand/RDMA
    cp -a /usr/lib/x86_64-linux-gnu/libibverbs*.so* /staging/usr/lib/ 2>/dev/null || true
    cp -a /usr/lib/x86_64-linux-gnu/librdmacm*.so* /staging/usr/lib/ 2>/dev/null || true
    cp -a /usr/lib/x86_64-linux-gnu/libnl*.so* /staging/usr/lib/ 2>/dev/null || true
    # NUMA
    cp -a /usr/lib/x86_64-linux-gnu/libnuma*.so* /staging/usr/lib/ 2>/dev/null || true
    # Other dependencies
    cp -a /usr/lib/x86_64-linux-gnu/libltdl*.so* /staging/usr/lib/ 2>/dev/null || true
    cp -a /usr/lib/x86_64-linux-gnu/libxml2*.so* /staging/usr/lib/ 2>/dev/null || true

    # -------------------------------
    # Build info
    # -------------------------------
    cat > /staging/etc/mugrid-build-info << EOF
MUGRID_VERSION=${MUGRID_VERSION}
OMPI_VERSION=${OMPI_VERSION}
FFTW_VERSION=${FFTW_VERSION}
PNETCDF_VERSION=${PNETCDF_VERSION}
BUILD_DATE=$(date -Iseconds)
TARGET_ARCH=znver3
EOF

    echo "=========================================="
    echo "Staging area summary:"
    du -sh /staging/*
    echo "=========================================="


######################################################################
# STAGE 2: RUNTIME
# Minimal Ubuntu container with only essential runtime components
######################################################################

Bootstrap: docker
From: ubuntu:24.04
Stage: runtime

%arguments
MUGRID_VERSION=0.102.0

%files from build
    /staging/usr/local/ /usr/local
    /staging/usr/lib/ /usr/lib
    /staging/etc/mugrid-build-info /etc/mugrid-build-info

%post
    export DEBIAN_FRONTEND=noninteractive

    # ================================================================
    # Install only essential runtime packages
    # ================================================================
    apt-get update
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        libstdc++6 \
        libgcc-s1 \
        libc6 \
        zlib1g \
        liblzma5 \
        libffi8 \
        libgfortran5 \
        libnuma1 \
        ca-certificates

    # Install Python packages that need to be present in runtime
    pip install --break-system-packages --no-cache-dir numpy scipy

    # Install mpi4py (uses our MPI libraries from build stage)
    pip install --break-system-packages --no-cache-dir mpi4py

    # Install NuMPI
    pip install --break-system-packages --no-cache-dir NuMPI

    # ================================================================
    # Cleanup to minimize image size
    # ================================================================
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    rm -rf /usr/share/doc /usr/share/man /usr/share/info
    rm -rf /var/cache/apt/archives

    # ================================================================
    # Configure library paths
    # ================================================================
    cat > /etc/ld.so.conf.d/mugrid.conf << 'EOF'
/usr/local/lib
/usr/local/lib/openmpi
/usr/lib
EOF

    ldconfig

%environment
    export PATH=/usr/local/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib/openmpi:$LD_LIBRARY_PATH
    export PYTHONPATH=/usr/local/lib/python3.12/dist-packages:$PYTHONPATH
    export OPAL_PREFIX=/usr/local
    export LC_ALL=C
    export PYTHONUNBUFFERED=1
    export PYTHONUSERSITE=1

%runscript
    exec python3 "$@"

%test
    python3 -c "import numpy; print('NumPy:', numpy.__version__)"
    python3 -c "import scipy; print('SciPy:', scipy.__version__)"
    python3 -c "import muGrid; print('muGrid:', muGrid.__version__)"

%help
    muGrid - Grid-based Simulation Library for NEMO2
    ================================================

    This container provides muGrid compiled for AMD EPYC Milan/Zen3 (NEMO2).
    Multi-stage build for minimal container size.

    Build info: /etc/mugrid-build-info

    Features:
      - OpenMPI 5.0.7 with UCX transport
      - FFTW 3.3.10 with MPI support
      - PnetCDF for parallel I/O
      - NuMPI for parallel algorithms

    Usage:
      # Run Python script with muGrid
      srun apptainer run mugrid.sif script.py

      # Check muGrid version
      apptainer exec mugrid.sif python3 -c "import muGrid; print(muGrid.__version__)"

      # Interactive Python
      apptainer exec mugrid.sif python3

    Note: Do NOT load any MPI module on NEMO2. Slurm handles process
    management via PMIx.

%labels
    Author Pastewka Lab
    Version {{ MUGRID_VERSION }}
    Description muGrid for NEMO2 (Milan/Zen3) - minimal runtime container
